---
title: "2017 대통령 선거 결과 지도"
author: "Dr.Kevin"
date: "7/29/2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 300)
```

지난해 19대 대통령 선거가 있었습니다. 선거 결과를 지도로 시각화하는 포스팅을 작성해보았습니다. 각 코드에 설명을 주석으로 붙였습니다. 선거 결과 데이터는 [중앙선거관리위원회 홈페이지](http://www.nec.go.kr/portal/main.do)에서 내려받았습니다. 

```{r eval=FALSE}
# 필요 패키지를 불러옵니다. 
library(dplyr)
library(stringr)
library(readxl)
library(xlsx)

# 선거 결과 데이터를 불러옵니다.
result <- read_xlsx(path = './data/제19대 대통령선거 개표자료.xlsx')

# 첫 행의 후보자 이름만 추출합니다. 
candidates <- result[1, 7:19] %>% str_split(pattern = '\r\n') %>% sapply(FUN = `[`, 2)

# 후보자 이름을 컬럼명으로 변경합니다.
colnames(x = result)[7:19] <- candidates
colnames(x = result)[20] <- '계'

# 첫 행을 삭제합니다.
result <- result[-1, ]

# 문자 벡터를 숫자 벡터로 변환합니다.
result[, 7:20] <- data.matrix(frame = result[, 7:20])

# '읍면동명' 컬럼의 값이 '합계'인 것만 남깁니다.
result <- result[result$읍면동명 == '합계', ]

# '읍면동명' 및 '투표구명' 컬럼을 삭제합니다.
result <- result[, -c(3:4)]

# NA인 행을 삭제합니다.
result <- result[complete.cases(result), ]

# 세종특별자치시의 '구시군명'을 '세종시'로 변경합니다.
result$구시군명[result$구시군명 == '세종특별자치시'] <- '세종시'

# '시도명'과 '구시군명'을 합친 '지역명' 컬럼을 생성합니다.
result$지역명 <- str_c(result$시도명, result$구시군명, sep = ' ')

# 컬럼의 순서를 변경합니다. 
result <- result[, c(21, 1:20)]

# 시와 구에 공백을 추가합니다. 
result$지역명 <- result$지역명 %>% str_replace_all(pattern = '(?=\\w+구)시', replacement = '시 ')

# 후보별 득표율 컬럼을 생성합니다. 
result[, 22:26] <- result[, 6:10] %>% sapply(FUN = function(x) (x / result$계 * 100) %>% round(digits = 1L))
colnames(x = result)[22:26] <- colnames(x = result)[6:10] %>% str_c('R')

# 지역별로 득표율이 가장 높은 후보를 확인합니다.
result$최대R <- apply(X = result[, 22:26], MARGIN = 1, FUN = function(x) which(x == max(x)))

# 최대 득표정당색을 지정합니다.
result$색상 <- ifelse(test = result$최대R == 1, yes = 'blue', no = 'red')
```

전국 250개 지방자치단체 시/군/구청의 위경도 좌표를 얻습니다. 구글 지도 API를 활용하려면 [Google Maps Platforms](https://developers.google.com/maps/documentation/geocoding/get-api-key)에서 인증키를 발급받아야 합니다. 

```{r eval=FALSE}
# ggmap 2.7을 설치합니다. (아직 CRAN에 등록되어 있지 않습니다.)
# devtools::install_github('dkahle/ggmap')

# 필요 패키지를 불러옵니다. 
library(ggmap)

# 구글 지도 API 인증키를 등록합니다. 
register_google(key = '자신의 구글 지도 API 인증키를 입력하세요')

# 지역명으로 위경도 좌표를 얻습니다. 
areaCoords <- geocode(location = enc2utf8(x = str_c(result$지역명, '청')))

# 위경도 좌표가 NA인 건수를 확인합니다. 
(is.na(x = areaCoords) == TRUE) %>% sum()

# result에 위경도 좌표를 붙입니다.
result <- cbind(result, areaCoords)

# RDS로 저장합니다.
saveRDS(object = result, file = '2017_Presidential_Election_Result.RDS')
```

```{r echo=FALSE}
# RDS를 불러옵니다.
result <- readRDS(file = './data/2017_Presidential_Election_Result.RDS')
```

**leaflet** 패키지를 활용하여 동적 지도 이미지를 구현해보겠습니다. 250 지방자치단체 시/군/구청의 위경도 좌표에 가장 높은 득표율을 얻은 후보자의 정당 색상으로 작은 원을 그리고, 그 원을 클릭하면 상위 2명의 후보자별 득표율을 표시하도록 설정합니다.

```{r message=FALSE}
# 필요 패키지를 불러옵니다. 
library(leaflet)
```

```{r}
# shinyApp으로 동적 지도 시각화합니다.
renderLeaflet({
  result %>% 
    leaflet() %>% 
    setView(lng = median(x = result$lon),
            lat = median(x = result$lat),
            zoom = 7) %>% 
    addCircles(lng = ~ lon,
               lat = ~ lat,
               radius = ~ exp(x = 8),
               weight = 1,
               color = 'black',
               popup = ~ str_c('[', 지역명, '] ', '문재인 : ', 문재인R, ', ', '홍준표 : ', 홍준표R),
               fillColor = ~ 색상,
               opacity = 0) %>% 
    addProviderTiles(provider = 'CartoDB.Positron')
})
```

이상으로 지방자치단체 중심지역에 상위 2명의 후보자별 득표율을 동적 지도 이미지로 구현해봤습니다. 향후 행정경계구역 데이터를 활용하여 다각형으로 구현해보겠습니다. 
