R을 이용하여 2017 프로야구 타자스탯 데이터 수집하기 (웹크롤러)
--------------------------------------------------------------

KBReport 웹페이지 <http://www.kbreport.com/main> 화면 상단 메뉴에서 "선수기록"을 클릭하면 아래에 선수 스탯이 테이블 형태로 출력됩니다.
이번 예제에서는 "팀-전체", "포지션-전체", "시즌 시작-2017", "종료 시즌-2017", "정규시즌", "분류-선택안함", "타석수-전체"로 상세 설정한 후
"결과" 버튼을 클릭하여 출력되는 텍스트 데이터를 수집해보도록 하겠습니다.

``` r
# 필요한 라이브러리 불러오기
library(httr)
library(rvest)
library(dplyr)
library(stringr)

# 타겟 URL 요소 지정
year <- "2017"
main <- "http://www.kbreport.com/leader/main"
stat <- "?order=oWAR&orderType=DESC"
ybgn <- paste0("&year_from=", year)
yend <- paste0("&year_to=", year)
game <- "&gameType=R"   # 정규시즌

# URL 조립하기 
url <- paste0(main, stat, ybgn, yend, game)
cat(url)

# URL로 접속하여 html 받기
resp <- GET(url)

# 서버 응답 상태 확인하기 (200이면 정상)
status_code(resp)

# html을 텍스트 형태로 출력하여 육안으로 html 확인하기 
# 아래 코드를 실행하면 결과 창이 지저분해지므로 통과! 
# cat(content(resp, as = 'text'))
```

위 사이트에서 크롬 개발자도구를 실행한 후 'elements' 메뉴에서 우리가 얻고자 하는 타자 스탯 정보가 포함된 `<tbody>` 태그는 `<table class="ltb-table responsive">` 하위에 있는 것을 알 수 있습니다.

그런데 이 부분은 JavaScripit로 뒤늦게 불려와지는 것이므로 GET 함수로 받아오는 html에는 포함되어 있지 않습니다.

``` r
# 실제로 해당하는 태그가 없는지 확인
html <- read_html(resp)
html %>% html_nodes(css = "table.ltb-table")
```

위 문제를 해결하는 방법은 2가지가 있는데,
하나는 크롬의 사용자도구에서 '네트워크' 탭을 열고 F5 새로고침을 실행해서 원하는 테이블이 화면에 렌더링되는 시점을 포착하여 관련 항목을 찾는 방법이고,
또 다른 하나는 RSelenium을 사용하여 원하는 코드를 얻는 방법입니다. 하지만 두 번째 방법은 속도가 느리다는 단점이 있으므로,
이번에는 첫 번째 방법을 사용하여 데이터를 수집해 보겠습니다.

먼저 크롬 개발자도구를 실행시키고 "network"로 이동하고 창을 모두 지운 후(clear) 새로고침(F5) 실행합니다. 개발자도구 상단 메뉴 중 3번 째 줄에서
"XHR"을 선택하면, 'ajax'라는 항목이 바로 원하는 스탯 테이블을 뿌려주는 역할을 합니다. POST 방식으로 요청하고, 응답을 얻으면 해결됩니다!

``` r
tbl <- POST(url = "http://www.kbreport.com/leader/list/ajax",
            encode = "form",
            body = list(
              row = 20,
              order = "oWAR",
              orderType = "DESC",
              year_from = 2017,
              year_to = 2017,
              gameType = "R",
              page = 1))

# 반응 상태코드 정상
status_code(tbl)

# 이번에도 육안으로 확인해보고 싶으면 아래 명령을 따로 실행해보세요
# cat(content(tbl, as = 'text'))

# 원하는 태그가 있는지 확인
read_html(tbl) %>% 
  html_nodes("table.ltb-table")

# html_table() 함수를 이용하여 쉽게 정리하고 데이터 프레임으로 변환
read_html(tbl) %>% 
  html_nodes("table.ltb-table") %>% 
  html_table() %>% 
  as.data.frame()
```

``` r
# 각 테이블마다 20명의 선수만 보여지므로 총 15 페이지를 순환하여 수집
hitterStat <- data.frame()

for (i in 1:15) {
  tbl <- POST(url = "http://www.kbreport.com/leader/list/ajax",
              encode = "form",
              body = list(
                row = 20,
                order = "oWAR",
                orderType = "DESC",
                year_from = 2017,
                year_to = 2017,
                gameType = "R",
                page = i))
  
  df <- read_html(tbl) %>% 
    html_nodes("table.ltb-table") %>% 
    html_table() %>% 
    as.data.frame()
  
  hitterStat <- rbind(hitterStat, df)
}
```

``` r
# 데이터 테이블 구조 확인하기
str(hitterStat)

# 총 292명의 선수, 20개의 컬럼으로 구성되어 있음
# 첫 번째 컬럼명은 "순위"로 변경해줄 필요 있고, 
# 14 ~ 20번 컬럼은 문자벡터로 되어 있어서 보정이 필요! 

# 요약정보 확인하기 (14 ~ 20번 컬럼만!)
table(hitterStat[14])
table(hitterStat[15])

# 위 컬럼들에서 일부 선수들이 "-"값을 가짐 
# 이것을 NA로 치환한 후, 숫자벡터로 변환해줌 
hitterStat[hitterStat == "-"] <- NA
hitterStat[, 14:20] <- data.matrix(hitterStat[, 14:20])

# 데이터 테이블 구조 다시 확인하기
str(hitterStat)

# 첫 번째 컬럼명을 "순위"로 변경하기
colnames(hitterStat)[1] <- "순위"

# 첫 10행만 미리보기 
head(x = hitterStat, n = 10)
```

``` r
# xlsx 파일로 저장하기 
library(xlsx)
write.xlsx(x = hitterStat, 
           file = "./data/2017 Baseball hitter stat.xlsx",
           row.names = FALSE)
```

이 데이터를 가지고 여러 가지 그래프를 그려봄으로써 탐색적 데이터 분석(EDA)을 하는 포스트는 따로 올릴 예정입니다.
