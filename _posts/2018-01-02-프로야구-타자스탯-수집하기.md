R을 이용하여 2017 프로야구 타자스탯 데이터 수집하기 (웹크롤러)
--------------------------------------------------------------

KBReport 웹페이지 <http://www.kbreport.com/main> 화면 상단 메뉴에서
"선수기록"을 클릭하면 아래에 선수 스탯이 테이블 형태로 출력됩니다.  
이번 예제에서는 "팀-전체", "포지션-전체", "시즌 시작-2017", "종료
시즌-2017", "정규시즌", "분류-선택안함", "타석수-전체"로 상세 설정한
후  
"결과" 버튼을 클릭하여 출력되는 텍스트 데이터를 수집해보도록 하겠습니다.

    # 필요한 라이브러리 불러오기
    library(httr)
    library(rvest)

    ## Loading required package: xml2

    library(dplyr)
    library(stringr)

    # 타겟 URL 요소 지정
    year <- "2017"
    main <- "http://www.kbreport.com/leader/main"
    stat <- "?order=oWAR&orderType=DESC"
    ybgn <- paste0("&year_from=", year)
    yend <- paste0("&year_to=", year)
    game <- "&gameType=R"   # 정규시즌

    # URL 조립하기 
    url <- paste0(main, stat, ybgn, yend, game)
    cat(url)

    ## http://www.kbreport.com/leader/main?order=oWAR&orderType=DESC&year_from=2017&year_to=2017&gameType=R

    # URL로 접속하여 html 받기
    resp <- GET(url)

    # 서버 응답 상태 확인하기 (200이면 정상)
    status_code(resp)

    ## [1] 200

    # html을 텍스트 형태로 출력하여 육안으로 html 확인하기 
    # 아래 코드를 실행하면 결과 창이 지저분해지므로 통과! 
    # cat(content(resp, as = 'text'))

위 사이트에서 크롬 개발자도구를 실행한 후 'elements' 메뉴에서 우리가
얻고자 하는 타자 스탯 정보가 포함된 `<tbody>` 태그는
`<table class="ltb-table responsive">` 하위에 있는 것을 알 수 있습니다.

그런데 이 부분은 JavaScripit로 뒤늦게 불려와지는 것이므로 GET 함수로
받아오는 html에는 포함되어 있지 않습니다.

    # 실제로 해당하는 태그가 없는지 확인
    html <- read_html(resp)
    html %>% html_nodes(css = "table.ltb-table")

    ## {xml_nodeset (0)}

위 문제를 해결하는 방법은 2가지가 있는데,  
하나는 크롬의 사용자도구에서 '네트워크' 탭을 열고 F5 새로고침을 실행해서
원하는 테이블이 화면에 렌더링되는 시점을 포착하여 관련 항목을 찾는
방법이고,  
또 다른 하나는 RSelenium을 사용하여 원하는 코드를 얻는 방법입니다.
하지만 두 번째 방법은 속도가 느리다는 단점이 있으므로,  
이번에는 첫 번째 방법을 사용하여 데이터를 수집해 보겠습니다.

먼저 크롬 개발자도구를 실행시키고 "network"로 이동하고 창을 모두 지운
후(clear) 새로고침(F5) 실행합니다. 개발자도구 상단 메뉴 중 3번 째
줄에서  
"XHR"을 선택하면, 'ajax'라는 항목이 바로 원하는 스탯 테이블을 뿌려주는
역할을 합니다. POST 방식으로 요청하고, 응답을 얻으면 해결됩니다!

    tbl <- POST(url = "http://www.kbreport.com/leader/list/ajax",
                encode = "form",
                body = list(
                  row = 20,
                  order = "oWAR",
                  orderType = "DESC",
                  year_from = 2017,
                  year_to = 2017,
                  gameType = "R",
                  page = 1))

    # 반응 상태코드 정상
    status_code(tbl)

    ## [1] 200

    # 이번에도 육안으로 확인해보고 싶으면 아래 명령을 따로 실행해보세요
    # cat(content(tbl, as = 'text'))

    # 원하는 태그가 있는지 확인
    read_html(tbl) %>% 
      html_nodes("table.ltb-table")

    ## {xml_nodeset (1)}
    ## [1] <table class="ltb-table responsive">\n<tr>\n<th width="20px">#</th>\ ...

    # html_table() 함수를 이용하여 쉽게 정리하고 데이터 프레임으로 변환
    read_html(tbl) %>% 
      html_nodes("table.ltb-table") %>% 
      html_table() %>% 
      as.data.frame()

    ##    X.   선수명 팀명 경기 타석 타수 안타 홈런 득점 타점 볼넷 삼진 도루
    ## 1   1     최정   SK  130  527  430  136   46   89  113   70  107    1
    ## 2   2  김재환* 두산  144  636  544  185   35  110  115   81  123    4
    ## 3   3   최형우  KIA  142  629  514  176   26   98  120   96   82    0
    ## 4   4   박건우 두산  131  543  483  177   20   91   78   41   64   20
    ## 5   5 로사리오 한화  119  510  445  151   37  100  111   50   61   10
    ## 6   6   나성범   NC  125  561  498  173   24  103   99   48  116   17
    ## 7   7   손아섭 롯데  144  667  576  193   20  113   80   83   96   25
    ## 8   8   김선빈  KIA  137  529  476  176    5   84   64   39   40    4
    ## 9   9 버나디나  KIA  139  621  557  178   27  118  111   41  112   32
    ## 10 10   박민우   NC  106  452  388  141    3   84   47   46   51   11
    ## 11 11   김하성 넥센  141  601  526  159   23   90  114   58   65   16
    ## 12 12 스크럭스   NC  115  518  437  131   35   91  111   65  134    4
    ## 13 13     러프 삼성  134  591  515  162   31   90  124   60  107    2
    ## 14 14   구자욱 삼성  144  647  564  175   21  108  107   63  138   10
    ## 15 15   안치홍  KIA  132  545  487  154   21   95   93   43   70    7
    ## 16 16   한동민   SK  103  414  350  103   29   64   73   46   79    2
    ## 17 17   서건창 넥센  139  615  539  179    6   87   76   67   68   15
    ## 18 18   나지완  KIA  137  551  459  138   27   85   94   62  105    1
    ## 19 19   이대호 롯데  142  608  540  173   34   73  111   50   84    1
    ## 20 20   박용택   LG  138  596  509  175   14   83   90   72   88    4
    ##    BABIP  타율 출루율 장타율   OPS  wOBA  WAR
    ## 1  0.316 0.316  0.427  0.684 1.111 0.442 7.30
    ## 2  0.385 0.340  0.429  0.603 1.032 0.427 7.22
    ## 3  0.362 0.342  0.450  0.576 1.026 0.430 7.20
    ## 4  0.390 0.366  0.424  0.582 1.006 0.424 7.04
    ## 5  0.324 0.339  0.414  0.661 1.075 0.436 5.75
    ## 6  0.413 0.347  0.415  0.584 0.999 0.416 5.64
    ## 7  0.374 0.335  0.420  0.514 0.934 0.398 5.60
    ## 8  0.393 0.370  0.420  0.477 0.897 0.391 5.19
    ## 9  0.354 0.320  0.373  0.540 0.913 0.380 5.01
    ## 10 0.408 0.363  0.441  0.472 0.913 0.404 4.92
    ## 11 0.306 0.302  0.376  0.513 0.889 0.375 4.76
    ## 12 0.353 0.300  0.402  0.595 0.997 0.411 4.70
    ## 13 0.344 0.315  0.396  0.569 0.965 0.402 4.59
    ## 14 0.371 0.310  0.383  0.527 0.910 0.382 4.28
    ## 15 0.332 0.316  0.373  0.513 0.886 0.374 4.23
    ## 16 0.302 0.294  0.396  0.614 1.010 0.414 3.92
    ## 17 0.367 0.332  0.403  0.429 0.832 0.368 3.90
    ## 18 0.332 0.301  0.405  0.534 0.939 0.398 3.87
    ## 19 0.327 0.320  0.391  0.533 0.924 0.388 3.86
    ## 20 0.387 0.344  0.424  0.479 0.903 0.391 3.67

    # 각 테이블마다 20명의 선수만 보여지므로 총 15 페이지를 순환하여 수집
    hitterStat <- data.frame()

    for (i in 1:15) {
      tbl <- POST(url = "http://www.kbreport.com/leader/list/ajax",
                  encode = "form",
                  body = list(
                    row = 20,
                    order = "oWAR",
                    orderType = "DESC",
                    year_from = 2017,
                    year_to = 2017,
                    gameType = "R",
                    page = i))
      
      df <- read_html(tbl) %>% 
        html_nodes("table.ltb-table") %>% 
        html_table() %>% 
        as.data.frame()
      
      hitterStat <- rbind(hitterStat, df)
    }

    # 데이터 테이블 구조 확인하기
    str(hitterStat)

    ## 'data.frame':    292 obs. of  20 variables:
    ##  $ X.    : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ 선수명: chr  "최정" "김재환*" "최형우" "박건우" ...
    ##  $ 팀명  : chr  "SK" "두산" "KIA" "두산" ...
    ##  $ 경기  : int  130 144 142 131 119 125 144 137 139 106 ...
    ##  $ 타석  : int  527 636 629 543 510 561 667 529 621 452 ...
    ##  $ 타수  : int  430 544 514 483 445 498 576 476 557 388 ...
    ##  $ 안타  : int  136 185 176 177 151 173 193 176 178 141 ...
    ##  $ 홈런  : int  46 35 26 20 37 24 20 5 27 3 ...
    ##  $ 득점  : int  89 110 98 91 100 103 113 84 118 84 ...
    ##  $ 타점  : int  113 115 120 78 111 99 80 64 111 47 ...
    ##  $ 볼넷  : int  70 81 96 41 50 48 83 39 41 46 ...
    ##  $ 삼진  : int  107 123 82 64 61 116 96 40 112 51 ...
    ##  $ 도루  : int  1 4 0 20 10 17 25 4 32 11 ...
    ##  $ BABIP : chr  "0.316" "0.385" "0.362" "0.39" ...
    ##  $ 타율  : chr  "0.316" "0.34" "0.342" "0.366" ...
    ##  $ 출루율: chr  "0.427" "0.429" "0.45" "0.424" ...
    ##  $ 장타율: chr  "0.684" "0.603" "0.576" "0.582" ...
    ##  $ OPS   : chr  "1.111" "1.032" "1.026" "1.006" ...
    ##  $ wOBA  : chr  "0.442" "0.427" "0.43" "0.424" ...
    ##  $ WAR   : chr  "7.3" "7.22" "7.2" "7.04" ...

    # 총 292명의 선수, 20개의 컬럼으로 구성되어 있음
    # 첫 번째 컬럼명은 "순위"로 변경해줄 필요 있고, 
    # 14 ~ 20번 컬럼은 문자벡터로 되어 있어서 보정이 필요! 

    # 요약정보 확인하기 (14 ~ 20번 컬럼만!)
    table(hitterStat[14])

    ## 
    ##     -     0 0.000   0.1 0.143  0.15 0.159 0.167 0.179 0.182 0.185 0.191 
    ##    11    21     8     1     2     1     1     2     1     3     1     1 
    ##   0.2 0.200 0.205 0.211 0.214 0.218 0.222 0.231 0.233 0.238 0.242 0.244 
    ##     3     1     1     1     1     1     1     1     1     1     1     1 
    ## 0.246  0.25 0.250 0.252 0.257 0.259  0.26 0.263 0.264 0.267 0.268 0.269 
    ##     1     6     2     1     1     1     1     1     1     3     1     1 
    ## 0.272 0.273 0.275 0.276 0.277 0.279  0.28 0.282 0.283 0.285 0.286 0.287 
    ##     1     2     2     2     1     2     1     1     2     1     1     1 
    ## 0.288 0.289  0.29 0.290 0.291 0.292 0.293 0.294 0.297 0.299   0.3 0.300 
    ##     2     3     1     1     2     3     2     5     2     1     5     3 
    ## 0.301 0.302 0.303 0.305 0.306 0.308  0.31 0.311 0.313 0.314 0.316 0.317 
    ##     1     2     1     2     4     1     1     1     4     2     2     2 
    ## 0.318  0.32 0.321 0.323 0.324 0.326 0.327 0.328 0.329  0.33 0.331 0.332 
    ##     1     1     3     1     6     3     3     2     1     2     1     3 
    ## 0.333 0.334 0.335 0.337 0.338  0.34 0.340 0.341 0.342 0.343 0.344 0.346 
    ##    16     1     2     1     1     2     1     1     1     1     1     3 
    ## 0.347 0.348  0.35 0.351 0.352 0.353 0.354 0.355 0.356 0.358 0.359 0.362 
    ##     2     3     1     2     1     6     3     1     1     3     2     4 
    ## 0.363 0.364 0.365 0.367  0.37 0.371 0.374 0.375 0.378 0.381 0.383 0.384 
    ##     2     2     1     2     1     2     1     1     1     2     1     1 
    ## 0.385 0.387 0.388  0.39 0.393 0.394   0.4 0.408  0.41 0.413 0.417 0.418 
    ##     1     2     1     1     1     1     2     1     1     1     1     1 
    ## 0.423 0.429 0.455 0.474   0.5   0.6  0.75     1 1.000 
    ##     1     3     1     1     5     1     1     3     1

    table(hitterStat[15])

    ## 
    ##     -     0 0.048 0.077 0.083   0.1 0.105 0.111 0.118  0.13 0.133 0.136 
    ##     5    32     1     1     2     1     1     1     1     1     1     1 
    ## 0.138 0.139  0.14 0.143  0.15 0.151 0.165 0.167 0.170 0.171 0.176 0.182 
    ##     1     1     1     3     1     1     1     5     1     1     2     1 
    ## 0.183 0.184 0.186 0.188  0.19 0.191 0.194 0.195   0.2 0.203 0.205 0.207 
    ##     1     1     1     2     2     1     1     1     6     1     1     2 
    ## 0.209 0.212 0.214 0.216 0.217 0.219 0.221 0.222 0.224 0.225 0.227 0.228 
    ##     1     1     2     2     2     2     1     2     1     1     2     1 
    ## 0.229 0.231 0.232 0.233 0.234 0.235 0.236 0.237 0.238 0.239 0.241 0.242 
    ##     1     2     1     2     2     1     2     5     4     1     1     2 
    ## 0.243 0.245 0.247 0.248  0.25 0.252 0.254 0.256 0.257 0.259 0.261 0.262 
    ##     1     1     1     2     6     2     1     3     2     1     2     1 
    ## 0.263 0.264 0.265 0.267 0.268 0.269  0.27 0.271 0.272 0.273 0.274 0.276 
    ##     4     2     4     3     1     1     2     1     4     1     1     3 
    ## 0.277 0.278 0.279  0.28 0.282 0.283 0.284 0.285 0.286 0.287 0.289 0.291 
    ##     6     4     2     1     3     1     3     2     2     2     3     3 
    ## 0.292 0.293 0.294 0.296 0.297 0.299   0.3 0.301 0.302 0.303 0.304 0.306 
    ##     1     3     1     2     1     1     4     3     1     3     2     3 
    ## 0.307 0.308 0.309  0.31 0.311 0.312 0.313 0.315 0.316 0.318  0.32 0.321 
    ##     2     2     1     2     1     3     2     1     2     1     3     3 
    ## 0.322 0.324 0.325 0.327  0.33 0.332 0.333 0.335 0.339  0.34 0.342 0.344 
    ##     1     1     1     2     1     2     5     2     1     2     1     1 
    ## 0.347  0.35 0.354 0.363 0.366  0.37   0.4 0.429   0.5     1 
    ##     1     1     1     1     1     1     1     2     1     3

    # 위 컬럼들에서 일부 선수들이 "-"값을 가짐 
    # 이것을 NA로 치환한 후, 숫자벡터로 변환해줌 
    hitterStat[hitterStat == "-"] <- NA
    hitterStat[, 14:20] <- data.matrix(hitterStat[, 14:20])

    # 데이터 테이블 구조 다시 확인하기
    str(hitterStat)

    ## 'data.frame':    292 obs. of  20 variables:
    ##  $ X.    : int  1 2 3 4 5 6 7 8 9 10 ...
    ##  $ 선수명: chr  "최정" "김재환*" "최형우" "박건우" ...
    ##  $ 팀명  : chr  "SK" "두산" "KIA" "두산" ...
    ##  $ 경기  : int  130 144 142 131 119 125 144 137 139 106 ...
    ##  $ 타석  : int  527 636 629 543 510 561 667 529 621 452 ...
    ##  $ 타수  : int  430 544 514 483 445 498 576 476 557 388 ...
    ##  $ 안타  : int  136 185 176 177 151 173 193 176 178 141 ...
    ##  $ 홈런  : int  46 35 26 20 37 24 20 5 27 3 ...
    ##  $ 득점  : int  89 110 98 91 100 103 113 84 118 84 ...
    ##  $ 타점  : int  113 115 120 78 111 99 80 64 111 47 ...
    ##  $ 볼넷  : int  70 81 96 41 50 48 83 39 41 46 ...
    ##  $ 삼진  : int  107 123 82 64 61 116 96 40 112 51 ...
    ##  $ 도루  : int  1 4 0 20 10 17 25 4 32 11 ...
    ##  $ BABIP : num  0.316 0.385 0.362 0.39 0.324 0.413 0.374 0.393 0.354 0.408 ...
    ##  $ 타율  : num  0.316 0.34 0.342 0.366 0.339 0.347 0.335 0.37 0.32 0.363 ...
    ##  $ 출루율: num  0.427 0.429 0.45 0.424 0.414 0.415 0.42 0.42 0.373 0.441 ...
    ##  $ 장타율: num  0.684 0.603 0.576 0.582 0.661 0.584 0.514 0.477 0.54 0.472 ...
    ##  $ OPS   : num  1.11 1.03 1.03 1.01 1.07 ...
    ##  $ wOBA  : num  0.442 0.427 0.43 0.424 0.436 0.416 0.398 0.391 0.38 0.404 ...
    ##  $ WAR   : num  7.3 7.22 7.2 7.04 5.75 5.64 5.6 5.19 5.01 4.92 ...

    # 첫 번째 컬럼명을 "순위"로 변경하기
    colnames(hitterStat)[1] <- "순위"

    # 첫 10행만 미리보기 
    head(x = hitterStat, n = 10)

    ##    순위   선수명 팀명 경기 타석 타수 안타 홈런 득점 타점 볼넷 삼진 도루
    ## 1     1     최정   SK  130  527  430  136   46   89  113   70  107    1
    ## 2     2  김재환* 두산  144  636  544  185   35  110  115   81  123    4
    ## 3     3   최형우  KIA  142  629  514  176   26   98  120   96   82    0
    ## 4     4   박건우 두산  131  543  483  177   20   91   78   41   64   20
    ## 5     5 로사리오 한화  119  510  445  151   37  100  111   50   61   10
    ## 6     6   나성범   NC  125  561  498  173   24  103   99   48  116   17
    ## 7     7   손아섭 롯데  144  667  576  193   20  113   80   83   96   25
    ## 8     8   김선빈  KIA  137  529  476  176    5   84   64   39   40    4
    ## 9     9 버나디나  KIA  139  621  557  178   27  118  111   41  112   32
    ## 10   10   박민우   NC  106  452  388  141    3   84   47   46   51   11
    ##    BABIP  타율 출루율 장타율   OPS  wOBA  WAR
    ## 1  0.316 0.316  0.427  0.684 1.111 0.442 7.30
    ## 2  0.385 0.340  0.429  0.603 1.032 0.427 7.22
    ## 3  0.362 0.342  0.450  0.576 1.026 0.430 7.20
    ## 4  0.390 0.366  0.424  0.582 1.006 0.424 7.04
    ## 5  0.324 0.339  0.414  0.661 1.075 0.436 5.75
    ## 6  0.413 0.347  0.415  0.584 0.999 0.416 5.64
    ## 7  0.374 0.335  0.420  0.514 0.934 0.398 5.60
    ## 8  0.393 0.370  0.420  0.477 0.897 0.391 5.19
    ## 9  0.354 0.320  0.373  0.540 0.913 0.380 5.01
    ## 10 0.408 0.363  0.441  0.472 0.913 0.404 4.92

    # xlsx 파일로 저장하기 
    library(xlsx)

    ## Loading required package: rJava

    ## Loading required package: xlsxjars

    # 저장할 폴더가 없으면 새로 만들기
    newDir <- "./data"
    if (dir.exists(paths = newDir) == FALSE) dir.create(path = newDir)

    write.xlsx(x = hitterStat, 
               file = "./data/2017 Baseball hitter stat.xlsx",
               row.names = FALSE)

이 데이터를 가지고 여러 가지 그래프를 그려봄으로써 탐색적 데이터
분석(EDA)을 하는 포스트는 따로 올릴 예정입니다.
